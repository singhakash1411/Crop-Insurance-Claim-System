<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Application Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Crop Insurance System</a>
            <div class="navbar-text text-white" id="userInfo"></div>
            <button class="btn btn-outline-light" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container my-5">
        <h2 class="text-center mb-4">Insurance Application Form</h2>
        
        <form id="insuranceForm" class="needs-validation" novalidate enctype="multipart/form-data">
            <!-- Personal Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Personal Information</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="farmerName" class="form-label">Farmer Name</label>
                        <input type="text" class="form-control" id="farmerName" name="farmerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="aadharNumber" class="form-label">Aadhar Number</label>
                        <input type="text" class="form-control" id="aadharNumber" name="aadharNumber" 
                               pattern="[0-9]{12}" required>
                        <div class="form-text">12 digit Aadhar number</div>
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" 
                               pattern="[0-9]{10}" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Farm Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Farm Details</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="landArea" class="form-label">Land Area (in acres)</label>
                        <input type="number" class="form-control" id="landArea" name="landArea" 
                               step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="cropType" class="form-label">Crop Type</label>
                        <select class="form-select" id="cropType" name="cropType" required>
                            <option value="">Select crop type</option>
                            <option value="rice">Rice</option>
                            <option value="wheat">Wheat</option>
                            <option value="cotton">Cotton</option>
                            <option value="sugarcane">Sugarcane</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="soilType" class="form-label">Soil Type</label>
                        <select class="form-select" id="soilType" name="soilType" required>
                            <option value="">Select soil type</option>
                            <option value="clay">Clay</option>
                            <option value="sandy">Sandy</option>
                            <option value="loamy">Loamy</option>
                            <option value="black">Black</option>
                            <option value="red">Red</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="irrigationSource" class="form-label">Irrigation Source</label>
                        <select class="form-select" id="irrigationSource" name="irrigationSource" required>
                            <option value="">Select irrigation source</option>
                            <option value="canal">Canal</option>
                            <option value="well">Well</option>
                            <option value="borewell">Borewell</option>
                            <option value="rain">Rain-fed</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Document Upload -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Document Upload</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="aadharCard" class="form-label">Aadhar Card</label>
                        <input type="file" class="form-control" id="aadharCard" name="aadharCard" 
                               accept=".jpg,.jpeg,.png,.pdf" required>
                        <div id="aadharPreview" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <label for="landDocument" class="form-label">Land Ownership Document</label>
                        <input type="file" class="form-control" id="landDocument" name="landDocument" 
                               accept=".jpg,.jpeg,.png,.pdf" required>
                        <div id="landPreview" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <label for="bankDocument" class="form-label">Bank Document</label>
                        <input type="file" class="form-control" id="bankDocument" name="bankDocument" 
                               accept=".jpg,.jpeg,.png,.pdf" required>
                        <div id="bankPreview" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Verification Images -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Verification Images</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="gpsImages" class="form-label">GPS Location Images</label>
                        <input type="file" class="form-control" id="gpsImages" name="gpsImages" 
                               accept=".jpg,.jpeg,.png" multiple required>
                        <div id="gpsPreview" class="mt-2 d-flex flex-wrap"></div>
                    </div>
                    <div class="mb-3">
                        <label for="farmPhotos" class="form-label">Farm Photos</label>
                        <input type="file" class="form-control" id="farmPhotos" name="farmPhotos" 
                               accept=".jpg,.jpeg,.png" multiple required>
                        <div id="farmPreview" class="mt-2 d-flex flex-wrap"></div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">Submit Application</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Check authentication
        checkAuth();
        updateAuthUI();

        // Preview images
        function previewFiles(input, previewDiv) {
            const preview = document.getElementById(previewDiv);
            preview.innerHTML = '';
            
            const files = input.files;
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        preview.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        }

        // Add preview listeners
        document.getElementById('aadharCard').addEventListener('change', function() {
            previewFiles(this, 'aadharPreview');
        });
        document.getElementById('landDocument').addEventListener('change', function() {
            previewFiles(this, 'landPreview');
        });
        document.getElementById('bankDocument').addEventListener('change', function() {
            previewFiles(this, 'bankPreview');
        });
        document.getElementById('gpsImages').addEventListener('change', function() {
            previewFiles(this, 'gpsPreview');
        });
        document.getElementById('farmPhotos').addEventListener('change', function() {
            previewFiles(this, 'farmPreview');
        });

        // Handle form submission
        document.getElementById('insuranceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("Form submission started");

            // Validate all required fields
            const form = document.getElementById('insuranceForm');
            
            // Check if all required fields are filled
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            // Check file inputs
            const fileInputs = form.querySelectorAll('input[type="file"][required]');
            fileInputs.forEach(input => {
                if (!input.files || input.files.length === 0) {
                    isValid = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                alert('Please fill in all required fields correctly.');
                return;
            }

            try {
                // Create insurance data object
                const insuranceData = {
                    farmerName: document.getElementById('farmerName').value,
                    aadharNumber: document.getElementById('aadharNumber').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    address: document.getElementById('address').value,
                    landArea: document.getElementById('landArea').value,
                    cropType: document.getElementById('cropType').value,
                    soilType: document.getElementById('soilType').value,
                    irrigationSource: document.getElementById('irrigationSource').value,
                    submissionDate: new Date().toISOString(),
                    status: 'Pending',
                    applicationId: 'APP' + Date.now() // Generate a unique application ID
                };
                
                console.log("Insurance data created:", insuranceData);
                
                // Get existing applications or initialize empty array
                let applications = [];
                try {
                    const storedData = localStorage.getItem('insuranceApplications');
                    console.log("Stored data:", storedData);
                    if (storedData) {
                        applications = JSON.parse(storedData);
                    }
                } catch (parseError) {
                    console.error("Error parsing stored data:", parseError);
                    applications = [];
                }
                
                console.log("Current applications:", applications);
                
                // Add new application
                applications.push(insuranceData);
                
                // Save back to localStorage
                localStorage.setItem('insuranceApplications', JSON.stringify(applications));
                console.log("Data saved to localStorage");
                
                // No longer automatically generate and download PDF
                
                alert('Application submitted successfully! You can view and download your application from the Documents section.');
                window.location.href = 'new.html';
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to submit application. Please try again.');
            }
        });
        
        // Function to generate and download PDF
        function generateAndDownloadPDF(applicationData) {
            // Create a new jsPDF instance
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text("Crop Insurance Application", 20, 20);
            
            // Add application ID
            doc.setFontSize(12);
            doc.text(`Application ID: ${applicationData.applicationId}`, 20, 30);
            doc.text(`Submission Date: ${new Date(applicationData.submissionDate).toLocaleDateString()}`, 20, 37);
            
            // Add personal information
            doc.setFontSize(16);
            doc.text("Personal Information", 20, 50);
            doc.setFontSize(12);
            doc.text(`Farmer Name: ${applicationData.farmerName}`, 20, 60);
            doc.text(`Aadhar Number: ${applicationData.aadharNumber}`, 20, 67);
            doc.text(`Phone Number: ${applicationData.phoneNumber}`, 20, 74);
            doc.text(`Address: ${applicationData.address}`, 20, 81);
            
            // Add farm details
            doc.setFontSize(16);
            doc.text("Farm Details", 20, 100);
            doc.setFontSize(12);
            doc.text(`Land Area: ${applicationData.landArea} acres`, 20, 110);
            doc.text(`Crop Type: ${applicationData.cropType}`, 20, 117);
            doc.text(`Soil Type: ${applicationData.soilType}`, 20, 124);
            doc.text(`Irrigation Source: ${applicationData.irrigationSource}`, 20, 131);
            
            // Add status
            doc.setFontSize(16);
            doc.text("Application Status", 20, 150);
            doc.setFontSize(12);
            doc.text(`Status: ${applicationData.status}`, 20, 160);
            
            // Save the PDF
            doc.save(`Insurance_Application_${applicationData.applicationId}.pdf`);
        }
    </script>
</body>
</html>
